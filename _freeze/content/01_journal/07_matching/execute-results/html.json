{
  "hash": "a622b00fc5ffa51c0a8d439872ba828b",
  "result": {
    "markdown": "---\ntitle: \"Matching and Subclassification\"\nauthor: \"Moritz Seefeldt\"\n---\n\n\n# Assignment 1\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-1_d29ba1657f7f08d39aa8b632da423452'}\n\n```{.r .cell-code}\ndf <- readRDS((\"data/membership.rds\"))\n\ndag_model <- 'dag {\nbb=\"0,0,1,1\"\nCard [exposure,pos=\"0.075,0.4\"]\nAvg_purch [outcome,pos=\"0.4,0.4\"]\nAge [pos=\"0.1,0.2\"]\nSex [pos=\"0.35,0.2\"]\nPre_avg_purch [pos=\"0.2,0.6\"]\nCard -> Avg_purch\nPre_avg_purch -> Avg_purch\nPre_avg_purch -> Card\nAge -> Card\nAge -> Pre_avg_purch\nSex -> Card\nSex -> Pre_avg_purch\n}\n'\n# draw DAG\nggdag_status(dag_model) +\n  guides(fill = \"none\", color = \"none\") +  # Disable the legend\n  geom_dag_edges(edge_color = \"white\")\n```\n\n::: {.cell-output-display}\n![](07_matching_files/figure-html/unnamed-chunk-1-1.png){width=672}\n:::\n:::\n\n# Assignment 2\nPlease find the model summary at the end of this document.\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-2_a86b1d59d6b2e63e18ebf1c65864dcfd'}\n\n```{.r .cell-code}\n#model <- lm(avg_purch ~ card + pre_avg_purch + age + sex, data = df)\nmodel <- lm(avg_purch ~ card, data = df)\nsummary(model)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df)\n#> \n#> Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -101.515  -20.684   -0.199   20.424  120.166 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  65.9397     0.3965  166.29   <2e-16 ***\n#> card         25.2195     0.6095   41.38   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.11 on 9998 degrees of freedom\n#> Multiple R-squared:  0.1462,\tAdjusted R-squared:  0.1461 \n#> F-statistic:  1712 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n:::\n\n# Assignment 3\n\n::: {.cell hash='07_matching_cache/html/unnamed-chunk-3_94c31f53f379d71a26c3b9dc6851b406'}\n\n```{.r .cell-code}\ncem <- matchit(card ~ pre_avg_purch + age + sex,\n               data = df, \n               method = 'cem', \n               estimand = 'ATE')\n#summary(cem)\ndf_cem = match.data(cem)\nmodel_cem <- lm(avg_purch ~ card, data = df_cem, weights = weights)\nsummary(model_cem)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_cem, weights = weights)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -159.349  -20.459   -0.151   19.863  161.528 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  69.9896     0.3984  175.66   <2e-16 ***\n#> card         15.2043     0.6137   24.77   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.12 on 9878 degrees of freedom\n#> Multiple R-squared:  0.0585,\tAdjusted R-squared:  0.0584 \n#> F-statistic: 613.7 on 1 and 9878 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nnn <- matchit(card ~ pre_avg_purch + age + sex,\n              data = df,\n              method = \"nearest\",\n              distance = \"mahalanobis\",\n              replace = T)\n#summary(nn)\ndf_nn <- match.data(nn)\nmodel_nn <- lm(avg_purch ~ card, data = df_nn, weights = weights)\nsummary(model_nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_nn, weights = weights)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -132.730  -21.288   -1.675   18.318  146.631 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  76.5634     0.5881  130.19   <2e-16 ***\n#> card         14.5957     0.7514   19.42   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 30.43 on 6907 degrees of freedom\n#> Multiple R-squared:  0.05179,\tAdjusted R-squared:  0.05166 \n#> F-statistic: 377.3 on 1 and 6907 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nmodel_prop <- glm(card ~ pre_avg_purch + age + sex,\n                  data = df,\n                  family = binomial(link = \"logit\"))\n#summary(model_prop)\ndf_aug <- df %>% mutate(propensity = predict(model_prop, type = \"response\"))\n\n# Extend data by IPW scores\ndf_ipw <- df_aug %>% mutate(\n  ipw = (card/propensity) + ((1-card) / (1-propensity)))\n\n\nmodel_ipw <- lm(avg_purch ~ card,\n                data = df_ipw, \n                weights = ipw)\nsummary(model_ipw)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_ipw, weights = ipw)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -205.353  -28.995   -0.275   28.787  214.307 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  70.2628     0.4320  162.66   <2e-16 ***\n#> card         14.9573     0.6109   24.48   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 43.19 on 9998 degrees of freedom\n#> Multiple R-squared:  0.05657,\tAdjusted R-squared:  0.05647 \n#> F-statistic: 599.5 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nmodel_ipw_trim <- lm(avg_purch ~ card,\n                     data = df_ipw %>% filter(propensity %>% between(0.15, 0.85)),\n                     weights = ipw)\nsummary(model_ipw_trim)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n#> \n#> Call:\n#> lm(formula = avg_purch ~ card, data = df_ipw %>% filter(propensity %>% \n#>     between(0.15, 0.85)), weights = ipw)\n#> \n#> Weighted Residuals:\n#>      Min       1Q   Median       3Q      Max \n#> -205.353  -28.995   -0.275   28.787  214.307 \n#> \n#> Coefficients:\n#>             Estimate Std. Error t value Pr(>|t|)    \n#> (Intercept)  70.2628     0.4320  162.66   <2e-16 ***\n#> card         14.9573     0.6109   24.48   <2e-16 ***\n#> ---\n#> Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n#> \n#> Residual standard error: 43.19 on 9998 degrees of freedom\n#> Multiple R-squared:  0.05657,\tAdjusted R-squared:  0.05647 \n#> F-statistic: 599.5 on 1 and 9998 DF,  p-value: < 2.2e-16\n```\n:::\n\n```{.r .cell-code}\nmodelsummary::modelsummary(list(\"Naive\" = model,\n                                \"CEM\"  = model_cem,\n                                \"NN\"    = model_nn,\n                                \"IPW1\"  = model_ipw,\n                                \"IPW2\"  = model_ipw_trim))\n```\n\n::: {.cell-output-display}\n`````{=html}\n<table class=\"table\" style=\"width: auto !important; margin-left: auto; margin-right: auto;\">\n <thead>\n  <tr>\n   <th style=\"text-align:left;\">   </th>\n   <th style=\"text-align:center;\"> Naive </th>\n   <th style=\"text-align:center;\"> CEM </th>\n   <th style=\"text-align:center;\"> NN </th>\n   <th style=\"text-align:center;\">  IPW1 </th>\n   <th style=\"text-align:center;\">  IPW2 </th>\n  </tr>\n </thead>\n<tbody>\n  <tr>\n   <td style=\"text-align:left;\"> (Intercept) </td>\n   <td style=\"text-align:center;\"> 65.940 </td>\n   <td style=\"text-align:center;\"> 69.990 </td>\n   <td style=\"text-align:center;\"> 76.563 </td>\n   <td style=\"text-align:center;\"> 70.263 </td>\n   <td style=\"text-align:center;\"> 70.263 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\">  </td>\n   <td style=\"text-align:center;\"> (0.397) </td>\n   <td style=\"text-align:center;\"> (0.398) </td>\n   <td style=\"text-align:center;\"> (0.588) </td>\n   <td style=\"text-align:center;\"> (0.432) </td>\n   <td style=\"text-align:center;\"> (0.432) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> card </td>\n   <td style=\"text-align:center;\"> 25.220 </td>\n   <td style=\"text-align:center;\"> 15.204 </td>\n   <td style=\"text-align:center;\"> 14.596 </td>\n   <td style=\"text-align:center;\"> 14.957 </td>\n   <td style=\"text-align:center;\"> 14.957 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;box-shadow: 0px 1.5px\">  </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.610) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.614) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.751) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.611) </td>\n   <td style=\"text-align:center;box-shadow: 0px 1.5px\"> (0.611) </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Num.Obs. </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n   <td style=\"text-align:center;\"> 9880 </td>\n   <td style=\"text-align:center;\"> 6909 </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n   <td style=\"text-align:center;\"> 10000 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 </td>\n   <td style=\"text-align:center;\"> 0.146 </td>\n   <td style=\"text-align:center;\"> 0.058 </td>\n   <td style=\"text-align:center;\"> 0.052 </td>\n   <td style=\"text-align:center;\"> 0.057 </td>\n   <td style=\"text-align:center;\"> 0.057 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> R2 Adj. </td>\n   <td style=\"text-align:center;\"> 0.146 </td>\n   <td style=\"text-align:center;\"> 0.058 </td>\n   <td style=\"text-align:center;\"> 0.052 </td>\n   <td style=\"text-align:center;\"> 0.056 </td>\n   <td style=\"text-align:center;\"> 0.056 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> AIC </td>\n   <td style=\"text-align:center;\"> 96483.2 </td>\n   <td style=\"text-align:center;\"> 95595.0 </td>\n   <td style=\"text-align:center;\"> 67134.2 </td>\n   <td style=\"text-align:center;\"> 97072.1 </td>\n   <td style=\"text-align:center;\"> 97072.1 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> BIC </td>\n   <td style=\"text-align:center;\"> 96504.8 </td>\n   <td style=\"text-align:center;\"> 95616.6 </td>\n   <td style=\"text-align:center;\"> 67154.7 </td>\n   <td style=\"text-align:center;\"> 97093.7 </td>\n   <td style=\"text-align:center;\"> 97093.7 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> Log.Lik. </td>\n   <td style=\"text-align:center;\"> -48238.590 </td>\n   <td style=\"text-align:center;\"> -47794.497 </td>\n   <td style=\"text-align:center;\"> -33564.098 </td>\n   <td style=\"text-align:center;\"> -48533.031 </td>\n   <td style=\"text-align:center;\"> -48533.031 </td>\n  </tr>\n  <tr>\n   <td style=\"text-align:left;\"> RMSE </td>\n   <td style=\"text-align:center;\"> 30.11 </td>\n   <td style=\"text-align:center;\"> 30.08 </td>\n   <td style=\"text-align:center;\"> 30.17 </td>\n   <td style=\"text-align:center;\"> 30.54 </td>\n   <td style=\"text-align:center;\"> 30.54 </td>\n  </tr>\n</tbody>\n</table>\n\n`````\n:::\n:::",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/kePrint-0.0.1/kePrint.js\"></script>\r\n<link href=\"../../site_libs/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" />\r\n<link href=\"../../site_libs/pagedtable-1.1/css/pagedtable.css\" rel=\"stylesheet\" />\r\n<script src=\"../../site_libs/pagedtable-1.1/js/pagedtable.js\"></script>\r\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}